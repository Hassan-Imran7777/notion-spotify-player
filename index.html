<!DOCTYPE html>
<html>
<head>
    <title>Notion Spotify Player</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #1DB954; }
        .player-container { background: white; padding: 20px; border-radius: 10px; max-width: 400px; margin: 0 auto; }
        .controls { margin: 20px 0; text-align: center; }
        button { background: #1DB954; color: white; border: none; padding: 10px 20px; margin: 5px; border-radius: 5px; cursor: pointer; }
        button:hover { background: #1ed760; }
        .track-info { margin: 15px 0; text-align: center; }
        .playlist-list { margin: 10px 0; }
        select { width: 100%; padding: 10px; margin: 10px 0; }
        .status { margin: 10px 0; padding: 10px; background: #f0f0f0; border-radius: 5px; }
    </style>
</head>
<body>
    <div class="player-container">
        <h2>üéµ Notion Spotify Player</h2>
        
        <div class="status" id="status">Ready to connect...</div>
        
        <div id="login-section">
            <button onclick="login()">üéµ Connect to Spotify Premium</button>
        </div>
        
        <div id="player-section" style="display: none;">
            <div class="track-info">
                <div id="track-info">No track playing</div>
            </div>
            
            <div class="controls">
                <button onclick="previousTrack()">‚èÆÔ∏è Previous</button>
                <button onclick="togglePlay()" id="play-btn">‚ñ∂Ô∏è Play</button>
                <button onclick="nextTrack()">‚è≠Ô∏è Next</button>
            </div>
            
            <div class="playlist-list">
                <label><strong>Select Your Playlist:</strong></label>
                <select id="playlist-select" onchange="loadPlaylist()">
                    <option>Loading your playlists...</option>
                </select>
            </div>
        </div>
    </div>

    <script src="https://sdk.scdn.co/spotify-player.js"></script>
    <script>
        // Your Client ID (already inserted)
        const CLIENT_ID = '6ef98e0d97024c3bae9edc2a3bc5e0f4';
        
        // Your GitHub Pages URL
        const REDIRECT_URI = 'https://hassanimran304.github.io/notion-spotify-player/callback.html';
        
        let player;
        let access_token;
        let device_id;
        let is_paused = true;
        
        // Check for existing token in localStorage
        window.onload = function() {
            access_token = localStorage.getItem('spotify_access_token');
            if (access_token) {
                document.getElementById('status').textContent = 'Found saved login, initializing...';
                setTimeout(() => {
                    if (window.Spotify) {
                        initializePlayer();
                    } else {
                        document.getElementById('status').textContent = 'Waiting for Spotify SDK...';
                    }
                }, 1000);
            }
        };
        
        // Listen for auth callback
        window.addEventListener('message', function(event) {
            if (event.data.includes('access_token')) {
                const urlParams = new URLSearchParams(event.data.substring(1));
                access_token = urlParams.get('access_token');
                localStorage.setItem('spotify_access_token', access_token);
                
                document.getElementById('status').textContent = 'Login successful! Initializing player...';
                initializePlayer();
            }
        });
        
        // Spotify Web Playback SDK Ready
        window.onSpotifyWebPlaybackSDKReady = () => {
            if (access_token) {
                initializePlayer();
            }
        };
        
        function login() {
            document.getElementById('status').textContent = 'Redirecting to Spotify login...';
            
            const scope = 'streaming user-read-email user-read-private user-read-playback-state user-modify-playback-state playlist-read-private';
            
            const authUrl = `https://accounts.spotify.com/authorize` +
                `?client_id=${CLIENT_ID}` +
                `&response_type=token` +
                `&redirect_uri=${encodeURIComponent(REDIRECT_URI)}` +
                `&scope=${encodeURIComponent(scope)}`;
            
            // Open in popup window
            const popup = window.open(authUrl, 'spotify-auth', 'width=600,height=700');
            
            // Check if popup was blocked
            if (!popup) {
                document.getElementById('status').textContent = 'Popup blocked! Please allow popups and try again.';
            }
        }
        
        function initializePlayer() {
            document.getElementById('status').textContent = 'Connecting to Spotify...';
            
            player = new Spotify.Player({
                name: 'Notion Spotify Player',
                getOAuthToken: cb => { cb(access_token); },
                volume: 0.5
            });
            
            // Ready
            player.addListener('ready', ({ device_id: ready_device_id }) => {
                console.log('Ready with Device ID', ready_device_id);
                device_id = ready_device_id;
                document.getElementById('status').textContent = '‚úÖ Connected! Loading your playlists...';
                
                document.getElementById('login-section').style.display = 'none';
                document.getElementById('player-section').style.display = 'block';
                loadUserPlaylists();
            });
            
            // Player state changed
            player.addListener('player_state_changed', (state) => {
                if (!state) return;
                
                const track = state.track_window.current_track;
                const is_paused_new = state.paused;
                
                document.getElementById('track-info').innerHTML = 
                    `<strong>${track.name}</strong><br>by ${track.artists[0].name}<br><em>from ${track.album.name}</em>`;
                
                document.getElementById('play-btn').innerHTML = is_paused_new ? '‚ñ∂Ô∏è Play' : '‚è∏Ô∏è Pause';
                is_paused = is_paused_new;
                
                document.getElementById('status').textContent = is_paused_new ? '‚è∏Ô∏è Paused' : 'üéµ Now Playing';
            });
            
            // Error handling
            player.addListener('initialization_error', ({ message }) => {
                document.getElementById('status').textContent = `‚ùå Error: ${message}`;
            });
            
            player.addListener('authentication_error', ({ message }) => {
                document.getElementById('status').textContent = `‚ùå Auth Error: ${message}`;
                localStorage.removeItem('spotify_access_token');
            });
            
            // Connect to the player
            player.connect();
        }
        
        function togglePlay() {
            player.togglePlay();
        }
        
        function nextTrack() {
            player.nextTrack();
        }
        
        function previousTrack() {
            player.previousTrack();
        }
        
        async function loadUserPlaylists() {
            try {
                const response = await fetch('https://api.spotify.com/v1/me/playlists?limit=50', {
                    headers: {
                        'Authorization': `Bearer ${access_token}`
                    }
                });
                
                const data = await response.json();
                const select = document.getElementById('playlist-select');
                select.innerHTML = '<option value="">Choose a playlist...</option>';
                
                data.items.forEach(playlist => {
                    const option = document.createElement('option');
                    option.value = playlist.uri;
                    option.textContent = `${playlist.name} (${playlist.tracks.total} tracks)`;
                    select.appendChild(option);
                });
                
                document.getElementById('status').textContent = `‚úÖ Loaded ${data.items.length} playlists. Select one to start!`;
                
            } catch (error) {
                console.error('Error loading playlists:', error);
                document.getElementById('status').textContent = '‚ùå Error loading playlists';
            }
        }
        
        async function loadPlaylist() {
            const select = document.getElementById('playlist-select');
            const playlistUri = select.value;
            
            if (!playlistUri || !device_id) return;
            
            document.getElementById('status').textContent = 'üéµ Starting playlist...';
            
            try {
                await fetch(`https://api.spotify.com/v1/me/player/play?device_id=${device_id}`, {
                    method: 'PUT',
                    body: JSON.stringify({ context_uri: playlistUri }),
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${access_token}`
                    },
                });
            } catch (error) {
                console.error('Error playing playlist:', error);
                document.getElementById('status').textContent = '‚ùå Error playing playlist';
            }
        }
    </script>
</body>
</html>
