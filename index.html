<!DOCTYPE html>
<html>
<head><title>Notion Spotify Player</title>
<style>
  body{font-family:sans-serif;padding:20px;background:#1DB954;}
  .player{background:#fff;padding:20px;border-radius:10px;max-width:400px;margin:auto;}
  button{background:#1DB954;color:#fff;border:none;padding:10px 20px;margin:5px;border-radius:5px;cursor:pointer;}
  button:hover{background:#1ed760;}
  select{width:100%;padding:10px;margin:10px 0;}
  .status{padding:10px;background:#f0f0f0;border-radius:5px;margin:10px 0;}
</style>
</head>
<body>
  <div class="player">
    <h2>üéµ Notion Spotify Player</h2>
    <div class="status" id="status">Ready to connect‚Ä¶</div>
    <div id="login"><button onclick="login()">Connect to Spotify Premium</button></div>
    <div id="controls" style="display:none">
      <div id="track"></div>
      <button onclick="prev()">‚èÆÔ∏è</button>
      <button id="play">‚ñ∂Ô∏è</button>
      <button onclick="next()">‚è≠Ô∏è</button>
      <select id="list" onchange="playList()"></select>
    </div>
  </div>
  <script src="https://sdk.scdn.co/spotify-player.js"></script>
  <script>
    const CLIENT_ID='6ef98e0d97024c3bae9edc2a3bc5e0f4';
    const REDIRECT='https://hassanimran304.github.io/notion-spotify-player/callback.html';
    let deviceId, player, token;

    // PKCE helpers
    function rand(len){const c='ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~';const a=crypto.getRandomValues(new Uint8Array(len));return Array.from(a).map(i=>c[i%c.length]).join('');}
    function b64(u){return btoa(String.fromCharCode(...new Uint8Array(u))).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');}
    async function challenge(v){const d=await crypto.subtle.digest('SHA-256',new TextEncoder().encode(v));return b64(d);}

    // On load: check for token
    window.onload=()=>{ const t=localStorage.getItem('spotify_access_token'); if(t){token=t;init();} };
    // Listen for callback
    window.addEventListener('message',e=>{
      if(e.data.includes('access_token')){
        token=new URLSearchParams(e.data.substring(1)).get('access_token');
        localStorage.setItem('spotify_access_token',token);
        init();
      }
    });

    async function login(){
      const v=rand(128);localStorage.setItem('spotify_pkce_verifier',v);
      const c=await challenge(v);
      const s=['streaming','user-read-email','user-read-private','user-read-playback-state','user-modify-playback-state','playlist-read-private'].join(' ');
      const url='https://accounts.spotify.com/authorize?client_id='+CLIENT_ID+
                '&response_type=code&redirect_uri='+encodeURIComponent(REDIRECT)+
                '&scope='+encodeURIComponent(s)+'&code_challenge_method=S256&code_challenge='+c;
      location=url;
    }

    window.onSpotifyWebPlaybackSDKReady=()=>{ if(token) init(); };

    function init(){
      document.getElementById('status').textContent='Connecting‚Ä¶';
      document.getElementById('login').style.display='none';
      player=new Spotify.Player({name:'NotionPlayer',getOAuthToken:cb=>cb(token),volume:0.5});
      player.addListener('ready',({device_id})=>{
        window.deviceId=device_id;
        document.getElementById('status').textContent='Loading playlists‚Ä¶';
        loadPlaylists();
        document.getElementById('controls').style.display='block';
      });
      player.addListener('player_state_changed',s=>{
        if(!s)return;
        const t=s.track_window.current_track;
        document.getElementById('track').innerHTML=`<strong>${t.name}</strong> by ${t.artists[0].name}`;
        document.getElementById('play').textContent=s.paused?'‚ñ∂Ô∏è':'‚è∏Ô∏è';
      });
      player.connect();
    }

    async function loadPlaylists(){
      const r=await fetch('https://api.spotify.com/v1/me/playlists?limit=50',{headers:{Authorization:'Bearer '+token}});
      const d=await r.json(),sel=document.getElementById('list');
      sel.innerHTML='<option value="">Select‚Ä¶</option>';
      d.items.forEach(pl=>sel.appendChild(Object.assign(document.createElement('option'),{value:pl.uri,text:pl.name+' ('+pl.tracks.total+')'})));
      document.getElementById('status').textContent='Select a playlist';
    }

    async function playList(){
      const uri=document.getElementById('list').value;
      if(!uri||!deviceId)return;
      document.getElementById('status').textContent='Playing‚Ä¶';
      await fetch(`https://api.spotify.com/v1/me/player/play?device_id=${deviceId}`,{
        method:'PUT',headers:{Authorization:'Bearer '+token,'Content-Type':'application/json'},
        body:JSON.stringify({context_uri:uri})
      });
    }

    function togglePlay(){player.togglePlay();}
    function next(){player.nextTrack();}
    function prev(){player.previousTrack();}
  </script>
</body>
</html>
