<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Notion Spotify Player</title>
  <script src="https://sdk.scdn.co/spotify-player.js"></script>
  <style>
    body { font-family: sans-serif; background: #f5f5f5; display: flex; align-items: center; justify-content: center; height: 100vh; margin: 0; }
    .player { background: #fff; padding: 2rem; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); text-align: center; }
    button { background: #1db954; color: #fff; border: none; padding: 0.75rem 1.5rem; font-size: 1rem; border-radius: 4px; cursor: pointer; }
    button:hover { background: #17a74a; }
    #status { margin-bottom: 1rem; }
  </style>
</head>
<body>
  <div class="player">
    <div id="status">Initializing player…</div>
    <button id="connect">Connect to Spotify Premium</button>
  </div>

  <script>
    // Generate PKCE code challenge helpers
    function generateRandomString(length) {
      const charset = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~';
      let result = '';
      crypto.getRandomValues(new Uint8Array(length)).forEach(c => {
        result += charset[c % charset.length];
      });
      return result;
    }
    async function sha256(buffer) {
      const hash = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(buffer));
      return new Uint8Array(hash);
    }
    async function generateCodeChallenge(verifier) {
      const hashed = await sha256(verifier);
      // Base64-urlencode
      return btoa(String.fromCharCode(...hashed))
        .replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
    }

    // Start PKCE flow when user clicks Connect
    document.getElementById('connect').addEventListener('click', async () => {
      const clientId = '6ef98e0d97024c3bae9edc2a3bc5e0f4';
      const redirectUri = 'https://hassanimran304.github.io/notion-spotify-player/callback.html';
      const verifier = generateRandomString(128);
      localStorage.setItem('spotify_pkce_verifier', verifier);
      const challenge = await generateCodeChallenge(verifier);
      const authUrl = new URL('https://accounts.spotify.com/authorize');
      authUrl.searchParams.set('response_type', 'code');
      authUrl.searchParams.set('client_id', clientId);
      authUrl.searchParams.set('scope', 'streaming user-read-email user-read-private user-read-playback-state user-modify-playback-state');
      authUrl.searchParams.set('redirect_uri', redirectUri);
      authUrl.searchParams.set('code_challenge_method', 'S256');
      authUrl.searchParams.set('code_challenge', challenge);
      window.location = authUrl.toString();
    });

    // Listen for access token from callback via postMessage
    window.addEventListener('message', e => {
      if (typeof e.data !== 'string') return;
      if (!e.data.startsWith('#access_token=')) return;
      const accessToken = e.data.replace('#access_token=', '');
      console.log('Received access token:', accessToken);
      document.getElementById('status').innerText = 'Player initializing…';

      // Initialize Spotify Web Playback SDK
      const player = new Spotify.Player({
        name: 'Notion Music Player',
        getOAuthToken: cb => { cb(accessToken); }
      });

      // Error handling
      player.addListener('initialization_error', ({ message }) => {
        console.error('Init error:', message);
        document.getElementById('status').innerText = 'Initialization error';
      });
      player.addListener('authentication_error', ({ message }) => {
        console.error('Auth error:', message);
        document.getElementById('status').innerText = 'Authentication error';
      });
      player.addListener('account_error', ({ message }) => {
        console.error('Account error:', message);
        document.getElementById('status').innerText = 'Account error';
      });

      // Ready
      player.addListener('ready', ({ device_id }) => {
        console.log('Player ready on device', device_id);
        document.getElementById('status').innerText = 'Connected to Spotify';
        // Optionally transfer playback to this device
        fetch('https://api.spotify.com/v1/me/player', {
          method: 'PUT',
          headers: {
            'Authorization': 'Bearer ' + accessToken,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ device_ids: [device_id] })
        });
      });

      // Connect
      player.connect();
    });
  </script>
</body>
</html>
